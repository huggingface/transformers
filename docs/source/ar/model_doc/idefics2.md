# Idefics2

## ูุธุฑุฉ ุนุงูุฉ
ุงูุชุฑุญ ูููุฐุฌ Idefics2 ูู [ูุง ุงูุฐู ููู ุนูุฏ ุจูุงุก ููุงุฐุฌ ุงูุฑุคูุฉ ูุงููุบุฉุ](https://arxiv.org/abs/2405.02246) ุจูุงุณุทุฉ ููู ุชุฑููุดููุ ูููุฌู ููุฑูููููุ ููููุชูุฑ ุณุงูู. ููููู ุงูุนุซูุฑ ุนูู ุงูููุดูุฑ ุงููุฑุงูู [ููุง](https://huggingface.co/blog/idefics2).

Idefics2 ูู ูููุฐุฌ ููุชูุญ ูุชุนุฏุฏ ุงููุณุงุฆุท ููุจู ุชุณูุณูุงุช ุชุนุณููุฉ ูู ุฅุฏุฎุงูุงุช ุงูุตูุฑ ูุงููุตูุต ูููุชุฌ ูุฎุฑุฌุงุช ูุตูุฉ. ูููู ูููููุฐุฌ ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุญูู ุงูุตูุฑุ ููุตู ุงููุญุชูู ุงููุฑุฆูุ ูุฑูุงูุฉ ุงููุตุต ุงููุณุชูุฏุฉ ุฅูู ุตูุฑ ูุชุนุฏุฏุฉุ ุฃู ุงูุชุตุฑู ุจุจุณุงุทุฉ ููููุฐุฌ ูุบุฉ ููู ุจุฏูู ุฅุฏุฎุงูุงุช ุจุตุฑูุฉ. ุฅูู ูุญุณู IDEFICS-1ุ ุฎุงุตุฉ ูู ููู ุงููุณุชูุฏุงุชุ ุฃู ุงูุชุนุฑู ุงูุถูุฆู ุนูู ุงูุญุฑููุ ุฃู ุงูุงุณุชุฏูุงู ุงูุจุตุฑู. Idefics2 ุฎููู ุงููุฒู (8 ูููุงุฑ ูุนููุฉ) ููุนุงูู ุงูุตูุฑ ุจูุณุจุฉ ุนุฑุถ ุฅูู ุงุฑุชูุงุน ุฃุตููุฉ ูุฏูุฉุ ููุง ูุณูุญ ุจููุงุกุฉ ุงุณุชุฏูุงู ูุชุบูุฑุฉ.

ุงูููุฎุต ูู ุงููุฑูุฉ ูู ูุง ููู:

*ููุฏ ุฃุฏู ุงูุงูุชูุงู ุงููุชุฒุงูุฏ ุจููุงุฐุฌ ุงููุบุฉ ุงููุฑุฆูุฉ (VLMs) ุฅูู ุชุญุณููุงุช ูู ููุงุฐุฌ ุงููุบุฉ ุงููุจูุฑุฉ ููุญููุงุช ุงูุฑุคูุฉ. ูุนูู ุงูุฑุบู ูู ููุฑุฉ ุงูุฃุฏุจูุงุช ุญูู ูุฐุง ุงูููุถูุนุ ูุฅููุง ููุงุญุธ ุฃู ุงููุฑุงุฑุงุช ุงูุญุงุณูุฉ ุงููุชุนููุฉ ุจุชุตููู VLMs ูุง ุชููู ูุจุฑุฑุฉ ูู ูุซูุฑ ูู ุงูุฃุญูุงู. ููุญู ูุฌุงุฏู ุจุฃู ูุฐู ุงููุฑุงุฑุงุช ุบูุฑ ุงููุฏุนููุฉ ุชุนุฑูู ุงูุชูุฏู ูู ูุฐุง ุงููุฌุงู ูู ุฎูุงู ุฌุนู ูู ุงูุตุนุจ ุชุญุฏูุฏ ุงูุฎูุงุฑุงุช ุงูุชู ุชุญุณู ุฃุฏุงุก ุงููููุฐุฌ. ูููุนุงูุฌุฉ ูุฐู ุงููุดููุฉุ ูุฌุฑู ุชุฌุงุฑุจ ูุงุณุนุฉ ุงููุทุงู ุญูู ุงูููุงุฐุฌ ุงููุณุจูุฉ ุงูุชุฏุฑูุจุ ูุงุฎุชูุงุฑ ุงูููุฏุณุฉ ุงููุนูุงุฑูุฉุ ูุงูุจูุงูุงุชุ ูุฃุณุงููุจ ุงูุชุฏุฑูุจ. ููุดูู ุชูุญูุฏ ูุชุงุฆุฌูุง ุชุทููุฑ Idefics2ุ ููู VLM ุฃุณุงุณู ูุนุงู ูุจูุบ 8 ูููุงุฑุงุช ูุนููุฉ. ููุญูู Idefics2 ุฃุฏุงุกู ูุชููุฒูุง ุถูู ูุฆุฉ ุญุฌูู ุนุจุฑ ุงูุนุฏูุฏ ูู ุงููุนุงููุฑ ูุชุนุฏุฏุฉ ุงููุณุงุฆุทุ ููููู ุบุงูุจูุง ุนูู ูุฏู ุงููุณุงูุงุฉ ูุน ุงูููุงุฐุฌ ุงูุชู ูุจูุบ ุญุฌููุง ุฃุฑุจุนุฉ ุฃุถุนุงู. ููููู ุจุฅุทูุงู ุงููููุฐุฌ (ุงูุฃุณุงุณู ูุงูููุฌู ูุงูุฏุฑุฏุดุฉ) ุฅูู ุฌุงูุจ ูุฌููุนุงุช ุงูุจูุงูุงุช ุงูุชู ุชู ุฅูุดุงุคูุง ูุชุฏุฑูุจู.*

<img src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/transformers/model_doc/idefics2_architecture.png" alt="drawing" width="600"/>

<small>ููุฏุณุฉ Idefics2. ูุฃุฎูุฐุฉ ูู <a href="https://arxiv.org/abs/2405.02246">ุงููุฑูุฉ ุงูุฃุตููุฉ.</a></small>

ุชูุช ุงููุณุงููุฉ ุจูุฐุง ุงููููุฐุฌ ูู ูุจู [amyeroberts](https://huggingface.co/amyeroberts).
ูููู ุงูุนุซูุฑ ุนูู ุงูููุฏ ุงูุฃุตูู [ููุง](https://huggingface.co/HuggingFaceM4/idefics2).

## ูุตุงุฆุญ ุงูุงุณุชุฎุฏุงู

- ูููู ุฃู ูุญุชูู ูู ุนููุฉ ุนูู ุตูุฑ ูุชุนุฏุฏุฉุ ููููู ุฃู ูุฎุชูู ุนุฏุฏ ุงูุตูุฑ ุจูู ุงูุนููุงุช. ูุณูู ูููู ุงููุนุงูุฌ ุจููุก ุฅุฏุฎุงูุงุช ุฅูู ุงูุนุฏุฏ ุงูุฃูุตู ูู ุงูุตูุฑ ูู ุฏูุนุฉ ููุฅุฏุฎุงู ุฅูู ุงููููุฐุฌ.
- ููุฌุฏ ูุฏู ุงููุนุงูุฌ ุฎูุงุฑ `do_image_splitting`. ุฅุฐุง ูุงู `True`ุ ูุณูุชู ุชูุณูู ูู ุตูุฑุฉ ุฅุฏุฎุงู ุฅูู 4 ุตูุฑ ูุฑุนูุฉุ ูุณูุชู ุฏูุฌูุง ูุน ุงูุฃุตู ูุชุดููู 5 ุตูุฑ. ูุฐุง ูููุฏ ูุฒูุงุฏุฉ ุฃุฏุงุก ุงููููุฐุฌ. ุชุฃูุฏ ูู ุชุนููู `processor.image_processor.do_image_splitting` ุนูู `False` ุฅุฐุง ูู ูุชู ุชุฏุฑูุจ ุงููููุฐุฌ ุจุงุณุชุฎุฏุงู ูุฐุง ุงูุฎูุงุฑ.
- ูุฌุจ ุฃู ูููู `text` ุงูุฐู ุชู ุชูุฑูุฑู ุฅูู ุงููุนุงูุฌ ุฑููุฒ `<image>` ุญูุซ ูุฌุจ ุฅุฏุฑุงุฌ ุงูุตูุฑ. ู `<end_of_utterance>` ูู ููุงูุฉ ูู ุนุจุงุฑุฉ ุฅุฐุง ูุงู ุงููุต ุฑุณุงูุฉ ุฏุฑุฏุดุฉ.
- ููุฌุฏ ูุฏู ุงููุนุงูุฌ ุทุฑููุฉ `apply_chat_template` ุงูุฎุงุตุฉ ุจู ูุชุญููู ุฑุณุงุฆู ุงูุฏุฑุฏุดุฉ ุฅูู ูุต ูููู ุชูุฑูุฑู ุจุนุฏ ุฐูู ูู `text` ุฅูู ุงููุนุงูุฌ.

ูุซุงู ุนูู ููููุฉ ุงุณุชุฎุฏุงู ุงููุนุงูุฌ ุนูู ุฑุณุงุฆู ุงูุฏุฑุฏุดุฉ:

```python
import requests
from PIL import Image
from transformers import Idefics2Processor, Idefics2ForConditionalGeneration
import torch

device = "cuda" if torch.cuda.is_available() else "cpu"

url_1 = "http://images.cocodataset.org/val2017/000000039769.jpg"
url_2 = "http://images.cocodataset.org/val2017/000000219578.jpg"

image_1 = Image.open(requests.get(url_1, stream=True).raw)
image_2 = Image.open(requests.get(url_2, stream=True).raw)
images = [image_1, image_2]

messages = [{
        "role": "user",
        "content": [
                {"type": "text", "text": "Whatโs the difference between these two images?"},
                {"type": "image"},
                {"type": "image"},
        ],
}]

processor = Idefics2Processor.from_pretrained("HuggingFaceM4/idefics2-8b")
model = Idefics2ForConditionalGeneration.from_pretrained("HuggingFaceM4/idefics2-8b")
model.to(device)

# at inference time, one needs to pass `add_generation_prompt=True` in order to make sure the model completes the prompt
text = processor.apply_chat_template(messages, add_generation_prompt=True)
print(text)
# 'User: Whatโs the difference between these two images?<image><image><end_of_utterance>\nAssistant:'

inputs = processor(images=images, text=text, return_tensors="pt").to(device)

generated_text = model.generate(**inputs, max_new_tokens=500)
generated_text = processor.batch_decode(generated_text, skip_special_tokens=True)[0]
print("Generated text:", generated_text)
```

- ุฃุซูุงุก ุงูุชุฏุฑูุจุ ูู ุงูููู ุชุญุฏูุฏ ุงูุฑููุฒ ุงูุชู ูุง ูุฌุจ ุนูู ุงููููุฐุฌ ุชุนูููุง. ุจุงููุณุจุฉ ูู Idefics2ุ ููุฎูุถ ูุฐุง ุนุงุฏุฉู ุฅูู ุฑููุฒ ุงูุตูุฑ ูุงูุชุนุจุฆุฉ. ููุฐุง ูุนูู ุฃูู ูููู ุฅูุดุงุก ุงูุชุณููุงุช ููุง ููู:

```python
import requests
from PIL import Image
from transformers import Idefics2Processor, Idefics2ForConditionalGeneration
import torch

url_1 = "http://images.cocodataset.org/val2017/000000039769.jpg"
url_2 = "http://images.cocodataset.org/val2017/000000219578.jpg"

image_1 = Image.open(requests.get(url_1, stream=True).raw)
image_2 = Image.open(requests.get(url_2, stream=True).raw)
images = [image_1, image_2]

messages = [{
        "role": "user",
        "content": [
            {"type": "text", "text": "Whatโs the difference between these two images?"},
            {"type": "image"},
            {"type": "image"},
        ],
    },
    {
        "role": "assistant",
        "content": [
            {"type": "text", "text": "The difference is that one image is about dogs and the other one about cats."},
        ],
}]

device = "cuda" if torch.cuda.is_available() else "cpu"

processor = Idefics2Processor.from_pretrained("HuggingFaceM4/idefics2-8b")
model = Idefics2ForConditionalGeneration.from_pretrained("HuggingFaceM4/idefics2-8b")
model.to(device)

text = processor.apply_chat_template(messages, add_generation_prompt=False)
inputs = processor(images=images, text=text, return_tensors="pt").to(device)

labels = inputs.input_ids.clone()
labels[labels == processor.tokenizer.pad_token_id] = -100
labels[labels == model.config.image_token_id] = -100

inputs["labels"] = labels

outputs = model(**inputs)
loss = outputs.loss
loss.backward()
```

ูุฑุฌู ููุงุญุธุฉ ุฃูู ุนูุฏ ุชุฏุฑูุจ Idefics2 ุนูู ุงููุญุงุฏุซุงุช ูุชุนุฏุฏุฉ ุงูุฃุฏูุงุฑ ุจูู ุงููุณุชุฎุฏู ูุงููุณุงุนุฏุ ูุชู ุฃูุถูุง ุชุนููู ุฌููุน ุงูุฑููุฒ ุงูููุงุจูุฉ ูุฑุณุงุฆู ุงููุณุชุฎุฏู ุฅูู -100.

## ุชุญุณูู ุงููููุฐุฌ: Flash Attention

ุชูุถุญ ููุชุทูุงุช ุงูููุฏ ุฃุนูุงู ุงูุงุณุชุฏูุงู ุจุฏูู ุฃู ุญูู ุชุญุณูู. ููุน ุฐููุ ูููู ูููุฑุก ุฃู ูุณุฑุน ุจุดูู ูุจูุฑ ูู ุงููููุฐุฌ ูู ุฎูุงู ุงูุงุณุชูุงุฏุฉ ูู [Flash Attention](../perf_train_gpu_one.md#flash-attention-2)ุ ููู ุชูููุฐ ุฃุณุฑุน ูุขููุฉ ุงูุงูุชุจุงู ุงููุณุชุฎุฏูุฉ ุฏุงุฎู ุงููููุฐุฌ.

ุฃููุงูุ ุชุฃูุฏ ูู ุชุซุจูุช ุฃุญุฏุซ ุฅุตุฏุงุฑ ูู Flash Attention 2 ูุชุถููู ููุฒุฉ ูุงูุฐุฉ ุงูุงูุฒูุงู.

```bash
pip install -U flash-attn --no-build-isolation
```

ุชุฃูุฏ ุฃูุถูุง ูู ุฃู ูุฏูู ุฃุฌูุฒุฉ ูุชูุงููุฉ ูุน Flash-Attention 2. ุงูุฑุฃ ุงููุฒูุฏ ุนููุง ูู ุงููุซุงุฆู ุงูุฑุณููุฉ ูู [ูุณุชูุฏุน ุงูุงูุชุจุงู ุงูุณุฑูุน](https://github.com/Dao-AILab/flash-attention). ุชุฃูุฏ ุฃูุถูุง ูู ุชุญููู ูููุฐุฌู ูู ูุตู ุงูุฏูุฉ (ุนูู ุณุจูู ุงููุซุงู `torch.float16`).

ูุชุญููู ูุชุดุบูู ูููุฐุฌ ุจุงุณุชุฎุฏุงู Flash Attention-2ุ ูู ุจุจุณุงุทุฉ ุจุชุบููุฑ ููุชุทู ุงูููุฏ ุฃุนูุงู ุจุงูุชุบููุฑ ุงูุชุงูู:

```diff
model = Idefics2ForConditionalGeneration.from_pretrained(
"HuggingFaceM4/idefics2-8b",
+    torch_dtype=torch.float16,
+    attn_implementation="flash_attention_2",
).to(device)
```

## ุชุตุบูุฑ ุญุฌู Idefics2 ุจุงุณุชุฎุฏุงู ุงูุชูููู

ูุธุฑูุง ูุฃู ูููุฐุฌ Idefics2 ูุญุชูู ุนูู 8 ูููุงุฑุงุช ูุนููุฉุ ููุฐุง ูุชุทูุจ ุญูุงูู 16 ุฌูุฌุงุจุงูุช ูู ุฐุงูุฑุฉ GPU RAM ูู ูุตู ุงูุฏูุฉ (float16)ุ ุญูุซ ูุชู ุชุฎุฒูู ูู ูุนููุฉ ูู ุจุงูุชูู. ููุน ุฐููุ ูููู ุชูููู ุญุฌู ุงููููุฐุฌ ุจุงุณุชุฎุฏุงู [ุงูุชูููู](../quantization.md). ุฅุฐุง ุชู ุชูููู ุงููููุฐุฌ ุฅูู 4 ุจุชุงุช (ุฃู ูุตู ุจุงูุช ููู ูุนููุฉ)ุ ููุฐุง ูุชุทูุจ ููุท ุญูุงูู 3.5 ุฌูุฌุงุจุงูุช ูู ุฐุงูุฑุฉ ุงููุตูู ุงูุนุดูุงุฆู.

ุฅู ุชูููู ูููุฐุฌ ุจุณูุท ูุซู ุชูุฑูุฑ `quantization_config` ุฅูู ุงููููุฐุฌ. ููููู ุชุบููุฑ ููุชุทู ุงูููุฏ ุฃุนูุงู ุจุงูุชุบููุฑุงุช ุฃุฏูุงู. ุณูุณุชููุฏ ูู ุชูููู BitsAndyBytes (ูููู ุฑุงุฌุน [ูุฐู ุงูุตูุญุฉ](../quantization.md) ูุฃุณุงููุจ ุงูุชูููู ุงูุฃุฎุฑู):

```diff
+ from transformers import BitsAndBytesConfig

+ quantization_config = BitsAndBytesConfig(
+    load_in_4bit=True,
+    bnb_4bit_quant_type="nf4",
+    bnb_4bit_use_double_quant=True,
+    bnb_4bit_compute_dtype=torch.float16
+ )
model = Idefics2ForConditionalGeneration.from_pretrained(
    "HuggingFaceM4/idefics2-8b",
+    torch_dtype=torch.float16,
+    quantization_config=quantization_config,
).to(device)
```

## ุงูููุงุฑุฏ

ูุงุฆูุฉ ุจููุงุฑุฏ Hugging Face ุงูุฑุณููุฉ ูููุงุฑุฏ ุงููุฌุชูุน (ุงููุดุงุฑ ุฅูููุง ุจู ๐) ููุณุงุนุฏุชู ูู ุงูุจุฏุก ุจุงุณุชุฎุฏุงู Idefics2. ุฅุฐุง ููุช ููุชููุง ุจุชูุฏูู ููุฑุฏ ูุฅุฏุฑุงุฌู ููุงุ ููุฑุฌู ูุชุญ ุทูุจ ุณุญุจ ูุณูุฑุงุฌุนู! ูุฌุจ ุฃู ููุถุญ ุงูููุฑุฏ ุจุดูู ูุซุงูู ุดูุฆูุง ุฌุฏูุฏูุง ุจุฏูุงู ูู ุชูุฑุงุฑ ููุฑุฏ ููุฌูุฏ.

- ูููู ุงูุนุซูุฑ ุนูู ุฏูุชุฑ ููุงุญุธุงุช ุญูู ููููุฉ ุถุจุท ูููุฐุฌ Idefics2 ุนูู ูุฌููุนุฉ ุจูุงูุงุช ูุฎุตุตุฉ ุจุงุณุชุฎุฏุงู [ุงููุฏุฑุจ](../main_classes/trainer.md) [ููุง](https://colab.research.google.com/drive/1NtcTgRbSBKN7pYD3Vdx1j9m8pt3fhFDB?usp=sharing). ููู ูุฏุนู ูู ูู ุงูุถุจุท ุงูุฏููู ุงููุงูู ููุฐูู (ุงููููู) LoRa.
- ูููู ุงูุนุซูุฑ ุนูู ูุต ุจุฑูุฌู ุญูู ููููุฉ ุถุจุท ูููุฐุฌ Idefics2 ุจุงุณุชุฎุฏุงู ููุชุจุฉ TRL [ููุง](https://gist.github.com/edbeeching/228652fc6c2b29a1641be5a5778223cb).
- ูููู ุงูุนุซูุฑ ุนูู ุฏูุชุฑ ููุงุญุธุงุช ุชูุถูุญู ุญูู ุถุจุท ูููุฐุฌ Idefics2 ูุงุณุชุฎุฏุงูุงุช ุงุณุชุฎุฑุงุฌ JSON [ููุง](https://github.com/NielsRogge/Transformers-Tutorials/tree/master/Idefics2). ๐

## Idefics2Config

[[autodoc]] Idefics2Config

## Idefics2Model

[[autodoc]] Idefics2Model

- forward

## Idefics2ForConditionalGeneration

[[autodoc]] Idefics2ForConditionalGeneration

- forward

## Idefics2ImageProcessor

[[autodoc]] Idefics2ImageProcessor

- preprocess

## Idefics2Processor

[[autodoc]] Idefics2Processor

- __call__