#                ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨
#           This file was automatically generated from src/transformers/models/uvdoc/modular_uvdoc.py.
#               Do NOT edit this file manually as any edits will be overwritten by the generation of
#             the file from the modular. If any change should be done, please apply the change to the
#                          modular_uvdoc.py file directly. One of our CI enforces this.
#                ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨ðŸš¨
from typing import Optional, Union

import numpy as np

from ...feature_extraction_utils import BatchFeature
from ...image_processing_utils import BaseImageProcessor
from ...image_transforms import flip_channel_order, to_channel_dimension_format
from ...image_utils import (
    ChannelDimension,
    ImageInput,
    PILImageResampling,
    infer_channel_dimension_format,
    make_flat_list_of_images,
    to_numpy_array,
    valid_images,
    validate_preprocess_arguments,
)
from ...utils import filter_out_non_signature_kwargs
from ...utils.generic import TensorType


class UVDocImageProcessor(BaseImageProcessor):
    model_input_names = ["pixel_values"]

    """
    Image processor for the UVDoc model, tailored for document rectification tasks.
    This processor handles all preprocessing (resize, rescale, normalize, channel flip) and postprocessing
    steps required for UVDoc model inference on document images, using numpy-based operations for broad
    compatibility with PIL/numpy/torch image inputs.

    Args:
        do_resize (`bool`, *optional*, defaults to `True`):
            Whether to resize the input images to the specified `size`. Disabling this is not recommended
            as UVDoc expects fixed-size inputs for document rectification.
        size (`Dict[str, int]`, *optional*, defaults to `{"height": 256, "width": 256}`):
            Target size for resizing images, specified as a dictionary with "height" and "width" keys.
            Adjust based on the UVDoc model's input requirements.
        resample (`PILImageResampling`, *optional*, defaults to `PILImageResampling.BICUBIC`):
            Resampling filter to use for resizing. BICUBIC is recommended for document images to preserve
            text sharpness during resizing.
        do_rescale (`bool`, *optional*, defaults to `True`):
            Whether to rescale the pixel values from [0, 255] to [0, 1] using `rescale_factor`.
        rescale_factor (`Union[int, float]`, *optional*, defaults to `1/255`):
            Factor to scale pixel values by (e.g., 1/255 scales 0-255 to 0-1).
        do_normalize (`bool`, *optional*, defaults to `True`):
            Whether to normalize the input images using `image_mean` and `image_std`. Normalization aligns
            input data with the statistics used during UVDoc model training.
        image_mean (`Union[float, List[float]]`, *optional*, defaults to `[0.406, 0.456, 0.485]`):
            Mean values for image normalization (RGB order), matching the training dataset statistics.
        image_std (`Union[float, List[float]]`, *optional*, defaults to `[0.225, 0.224, 0.229]`):
            Standard deviation values for image normalization (RGB order), matching the training dataset statistics.

    Attributes:
        model_input_names (`List[str]`):
            List of input names expected by the UVDoc model (only "pixel_values" for image inputs).
    """

    def __init__(
        self,
        do_resize: bool = True,
        size: Optional[dict[str, int]] = None,
        resample: Optional[PILImageResampling] = PILImageResampling.BICUBIC,
        do_rescale: bool = True,
        rescale_factor: Union[int, float] = 1 / 255,
        do_normalize: bool = True,
        image_mean: Optional[Union[float, list[float]]] = [0.406, 0.456, 0.485],
        image_std: Optional[Union[float, list[float]]] = [0.225, 0.224, 0.229],
        **kwargs,
    ) -> None:
        """
        Initialize the UVDocImageProcessor with specified preprocessing parameters.
        Sets default size if not provided and stores all preprocessing hyperparameters.
        """
        super().__init__(**kwargs)
        size = size if size is not None else {"height": 256, "width": 256}

        self.do_resize = do_resize
        self.size = size
        self.do_rescale = do_rescale
        self.rescale_factor = rescale_factor
        self.do_normalize = do_normalize
        self.image_mean = image_mean
        self.image_std = image_std
        self.resample = resample

    @filter_out_non_signature_kwargs()
    def preprocess(
        self,
        images: ImageInput,
        size: Optional[dict[str, int]] = None,
        do_resize: Optional[bool] = None,
        resample: Optional[PILImageResampling] = None,
        do_rescale: Optional[bool] = None,
        rescale_factor: Optional[Union[int, float]] = None,
        do_normalize: Optional[bool] = None,
        image_mean: Optional[Union[float, list[float]]] = None,
        image_std: Optional[Union[float, list[float]]] = None,
        return_tensors: Optional[Union[TensorType, str]] = None,
        data_format: Union[str, ChannelDimension] = ChannelDimension.FIRST,
        input_data_format: Optional[Union[str, ChannelDimension]] = None,
    ) -> BatchFeature:
        """
        Preprocess input images for UVDoc model inference (numpy-based implementation).

        Args:
            images (`ImageInput`):
                Input images to process (can be PIL images, numpy arrays, torch tensors, or lists thereof).
            size (`Dict[str, int]`, *optional*):
                Override the target resize size (defaults to self.size).
            do_resize (`bool`, *optional*):
                Override the do_resize flag (defaults to self.do_resize).
            resample (`PILImageResampling`, *optional*):
                Override the resampling filter (defaults to self.resample).
            do_rescale (`bool`, *optional*):
                Override the do_rescale flag (defaults to self.do_rescale).
            rescale_factor (`Union[int, float]`, *optional*):
                Override the rescale factor (defaults to self.rescale_factor).
            do_normalize (`bool`, *optional*):
                Override the do_normalize flag (defaults to self.do_normalize).
            image_mean (`Union[float, List[float]]`, *optional*):
                Override the normalization mean (defaults to self.image_mean).
            image_std (`Union[float, List[float]]`, *optional*):
                Override the normalization std (defaults to self.image_std).
            return_tensors (`Union[TensorType, str]`, *optional*):
                Type of tensors to return (e.g., "pt" for PyTorch tensors, "np" for numpy arrays).
            data_format (`Union[str, ChannelDimension]`, *optional*, defaults to `ChannelDimension.FIRST`):
                Output channel dimension format (FIRST = [C, H, W], LAST = [H, W, C]).
            input_data_format (`Union[str, ChannelDimension]`, *optional*):
                Channel dimension format of the input images (inferred if None).

        Returns:
            `BatchFeature`: A BatchFeature object containing the processed "pixel_values" tensor.

        Raises:
            ValueError: If input images are of invalid type (not PIL/numpy/torch).
        """
        size = self.size if size is None else size
        do_resize = self.do_resize if do_resize is None else do_resize
        resample = self.resample if resample is None else resample
        do_rescale = self.do_rescale if do_rescale is None else do_rescale
        rescale_factor = self.rescale_factor if rescale_factor is None else rescale_factor
        do_normalize = self.do_normalize if do_normalize is None else do_normalize
        image_mean = self.image_mean if image_mean is None else image_mean
        image_std = self.image_std if image_std is None else image_std

        images = make_flat_list_of_images(images)

        validate_preprocess_arguments(
            do_rescale=do_rescale,
            rescale_factor=rescale_factor,
            do_normalize=do_normalize,
            image_mean=image_mean,
            image_std=image_std,
            size=size,
            do_resize=do_resize,
            resample=resample,
        )

        if not valid_images(images):
            raise ValueError("Invalid image type. Must be of type PIL.Image.Image, numpy.ndarray, or torch.Tensor")

        # All transformations expect numpy arrays
        images = [to_numpy_array(image) for image in images]

        if input_data_format is None:
            input_data_format = infer_channel_dimension_format(images[0])

        if do_rescale:
            images = [self.rescale(image, rescale_factor, input_data_format=input_data_format) for image in images]

        if do_normalize:
            images = [
                self.normalize(image, image_mean, image_std, input_data_format=input_data_format) for image in images
            ]
        # flip color channels from RGB to BGR
        images = [flip_channel_order(image, input_data_format=input_data_format) for image in images]
        images = [
            to_channel_dimension_format(image, data_format, input_channel_dim=input_data_format) for image in images
        ]

        encoded_inputs = BatchFeature(data={"pixel_values": images}, tensor_type=return_tensors)

        return encoded_inputs

    def post_process_document_rectification(self, images, scale=None):
        """
        Postprocess UVDoc model outputs to get rectified document images (numpy-based).
        Converts model output tensors back to 0-255 RGB images ready for saving/display.

        Args:
            images (`Union[np.ndarray, Tuple[np.ndarray, ...], List[np.ndarray]]`):
                Raw model outputs (logits) to postprocess (batch of images).
            scale (`Union[str, float, int]`, *optional*, defaults to 255.0):
                Scaling factor to convert normalized outputs back to 0-255 pixel values.

        Returns:
            `List[np.ndarray]`: List of rectified document images (uint8, [H, W, C], RGB).
        """
        scale = np.float32(scale) if isinstance(scale, (str, float)) else np.float32(255.0)

        return [self.doctr(img, scale) for img in images]

    def doctr(self, pred: Union[np.ndarray, tuple[np.ndarray, ...]], scale) -> np.ndarray:
        """
        Core postprocessing logic for a single document image (numpy-based).
        Converts model output tensor to a valid RGB image (uint8, [H, W, C]).

        Args:
            pred (`Union[np.ndarray, Tuple[np.ndarray, ...]]`):
                Raw model output for a single image (or tuple containing the output).
            scale (`np.float32`):
                Scaling factor to convert normalized values to 0-255.

        Returns:
            `np.ndarray`: Rectified document image (uint8, [H, W, C], RGB).

        Raises:
            AssertionError: If input is not a numpy array.
        """
        if isinstance(pred, tuple):
            im = pred[0].cpu().detach().numpy()
        else:
            im = pred.cpu().detach().numpy()
        assert isinstance(im, np.ndarray), "Invalid input 'im' in DocTrPostProcess. Expected a numpy array."
        im = im.squeeze()
        im = im.transpose(1, 2, 0)
        im *= scale
        im = im[:, :, ::-1]
        im = im.astype("uint8", copy=False)
        return im


__all__ = ["UVDocImageProcessor"]
