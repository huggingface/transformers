name: CircleCI Failure Summary Comment
# Requires repository secrets:
# - CIRCLE_TOKEN: API token with permission to query CircleCI pipelines

on:
  check_suite:
    types:
      - completed

jobs:
  comment:
    if: >
      github.event.check_suite.app.slug == 'circleci-checks' &&
      github.event.check_suite.conclusion != '' &&
      github.event.check_suite.pull_requests[0]
    runs-on: ubuntu-22.04
    permissions:
      pull-requests: write
    env:
      TARGET_BRANCH: ${{ github.event.check_suite.head_branch }}
      TARGET_SHA: ${{ github.event.check_suite.head_sha }}
      PR_NUMBER: ${{ github.event.check_suite.pull_requests[0].number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: python -m pip install requests

      - name: Find CircleCI workflow
        id: circleci
        env:
          CIRCLE_TOKEN: ${{ secrets.CIRCLE_TOKEN }}
        run: |
          WORKFLOW_ID=$(python scripts/find_circleci_workflow.py --branch "$TARGET_BRANCH" --sha "$TARGET_SHA")
          echo "workflow_id=$WORKFLOW_ID" >> $GITHUB_OUTPUT

      - name: Generate failure summary
        env:
          CIRCLE_TOKEN: ${{ secrets.CIRCLE_TOKEN }}
        run: |
          python utils/process_circleci_workflow_test_reports.py --workflow_id "${{ steps.circleci.outputs.workflow_id }}"

      - name: Post comment with failure summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -f outputs/failure_summary.json ]; then
            echo "failure_summary.json missing, skipping comment."
            exit 0
          fi
          failures=$(python -c "import json; print(len(json.load(open('outputs/failure_summary.json'))['failures']))")
          if [ "$failures" -eq 0 ]; then
            echo "No failures detected, skipping PR comment."
            exit 0
          fi
          body="$(cat outputs/failure_summary.md)"
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            -f body="$body"
